<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8">

  <title>How the Saga Pattern manages failures with AWS Lambda and Step Functions - Gmagon Software - handy and professional Mac apps.</title>

  <meta http-equiv="X-UA-Compatible" content="IE=8; IE=9; IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="robots" content="noodp" />
  <meta name="keywords" content="How the Saga Pattern manages failures with AWS Lambda and Step Functions" />
  <meta name="description" content="How the Saga Pattern manages failures with AWS Lambda and Step Functions" />

  <!-- Custom config og:image -->


  <!-- Open Graph -->
<meta name="description" content="How the Saga Pattern manages failures with AWS Lambda and Step Functions - Gmagon Software - handy and professional Mac apps.">
<meta property="og:type" content="apps">
<meta property="og:title" content="How the Saga Pattern manages failures with AWS Lambda and Step Functions - Gmagon Software - handy and professional Mac apps.">
<meta property="og:url" content="https://gmagon.com/blog/2017/09/04/how-the-saga-pattern-manages-failures-with-aws-lambda-and-step-functions/index.html">
<meta property="og:site_name" content="How the Saga Pattern manages failures with AWS Lambda and Step Functions - Gmagon Software - handy and professional Mac apps.">
<meta property="og:description" content="How the Saga Pattern manages failures with AWS Lambda and Step Functions - Gmagon Software - handy and professional Mac apps.">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://img1.tuicool.com/AZnm633.png!web">
<meta property="og:image" content="http://img2.tuicool.com/n6Nfieu.png!web">
<meta property="og:image" content="http://img0.tuicool.com/fYVvEni.png!web">
<meta property="og:image" content="http://img0.tuicool.com/6Rfqymb.png!web">
<meta property="og:image" content="http://img0.tuicool.com/36jEz2J.png!web">
<meta property="og:image" content="http://img1.tuicool.com/Jr677be.png!web">
<meta property="og:updated_time" content="2017-09-04T11:24:45.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How the Saga Pattern manages failures with AWS Lambda and Step Functions - Gmagon Software - handy and professional Mac apps.">
<meta name="twitter:description" content="How the Saga Pattern manages failures with AWS Lambda and Step Functions - Gmagon Software - handy and professional Mac apps.">
<meta name="twitter:image" content="http://img1.tuicool.com/AZnm633.png!web">
<meta name="twitter:site" content="gmagonshare">
<meta property="fb:admins" content="432634277117208">
<meat name="twitter:url" content="https://gmagon.com/blog/2017/09/04/how-the-saga-pattern-manages-failures-with-aws-lambda-and-step-functions/index.html">



  <!-- algolia_config -->
  
  
  <!-- Canonical links -->
  <link rel="canonical" href="https://gmagon.com/blog/2017/09/04/how-the-saga-pattern-manages-failures-with-aws-lambda-and-step-functions/index.html">

  <!-- Alternative links -->
  

  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/icon/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/icon/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/icon/mstile-144x144.png">

  <!-- CSS -->
  <link rel="stylesheet" href="/build/css/navy-7722a083b2.css">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/asset/styles/global.css">
  
  <!-- jQuery -->
  <script src="/js/jquery/jquery-3.2.1.min.js"></script>
<script src="/js/jquery/jquery-migrate-1.4.1.min.js"></script>



  <!-- ForPostLayout -->
  
    
    
  
  <!-- endForPostLayout -->

  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="Gmagon Software - handy and professional Mac apps.">

  <!-- algolia_search -->
  <script src="/assets/algolia/algoliasearchLite.min.js" async></script>

  <!-- Utils -->
<script src="/js/utils.js"></script>
</head>

<body>
  <div id="container">
    <header id="header">
  <div class="wrapper">
    <div id="header-inner" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Gmagon Software - handy and professional Mac apps.</a>
        <span>gmagon </span>
      </h1>
      <nav id="main-nav">
        <a href="/" class="main-nav-link ">Home</a><a href="/products/" class="main-nav-link ">Products</a><a href="/guide/" class="main-nav-link ">Guide</a><a href="/support/" class="main-nav-link ">Support</a><a href="/blog/" class="main-nav-link ">Blog</a>
        <div id="search-input-wrap">
          <a href="/search/" class="text-decoration-none ">
            <div id="search-input-icon">
              <i class="fa fa-search"></i>
            </div>
          </a>
        </div>
      </nav>
      <div id="lang-select-wrap">
        <label id="lang-select-label"><i class="fa fa-globe"></i><span>English</span></label>
        <select id="lang-select" data-canonical="">
          
            <option value="en" selected>English</option>
          
        </select>
      </div>
      <a id="mobile-nav-toggle">
        <span class="mobile-nav-toggle-bar"></span>
        <span class="mobile-nav-toggle-bar"></span>
        <span class="mobile-nav-toggle-bar"></span>
      </a>
    </div>
  </div>  
</header>
<div class="hide-wrap-head-top"></div>
    <div class="class-content-wrap">
  <div class="inner">
    <div class="inner-wrap fill-bunting font-e3">
      <h2 id="banner-title"> How the Saga Pattern manages failures with AWS Lambda and Step Functions </h2>
      <div id="banner-start">
        <a class="btn btn-static-secondary btn-shadow" href="https://gitter.im/Gmagon/support" ttarget="_blank" rel="nofollow me noopener noreferrer" >Need help?</a>
      </div>
    </div>
  </div>
</div>

<div class="class-content-wrap">
  <div class="wrapper">
    <div class="inner">
      <article class="article-container" itemscope itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
          <div class="hide-wrap-head-top"></div>
<article class="article post" itemscope itemtype="http://schema.org/Article">
  <header class="article-header">
    
      <h1 class="article-title" itemprop="name">How the Saga Pattern manages failures with AWS Lambda and Step Functions</h1>
    
    <a href="/blog/2017/09/04/how-the-saga-pattern-manages-failures-with-aws-lambda-and-step-functions/" class="article-date"><time datetime="2017-09-04T00:00:00.000Z">2017-09-04</time></a>
  </header>
  <div class="article-content" itemprop="articleBody">
    
    <div class="post-authors">
      <table class="app-download-table"> 
      <thead> 
        <tr> 
        <th>Article Media</th> 
        <th>Links</th> 
        </tr> 
      </thead> 
      <tbody> 
        <tr> 
        <td class="app-download-version">FaceBook</td> 
        <td class="on elevation1"><a href="https://www.facebook.com/groups/winandmac">https://www.facebook.com/groups/winandmac </a></td> 
        </tr> 
        <tr> 
        <td class="app-download-version">Twitter</td> 
        <td class="on elevation1"><a href="https://twitter.com/gmagonshare">https://twitter.com/gmagonshare </a></td> 
        </tr> 
      </tbody> 
      </table>
    </div>
    <h1 id="How-the-Saga-Pattern-manages-failures-with-AWS-Lambda-and-Step-Functions"><a href="#How-the-Saga-Pattern-manages-failures-with-AWS-Lambda-and-Step-Functions" class="headerlink" title="How the Saga Pattern manages failures with AWS Lambda and Step Functions"></a>How the Saga Pattern manages failures with AWS Lambda and Step Functions</h1><p>In the world of microservices it’s important to ensure data consistency is maintained across distributed transactions</p>
<p><img src="http://img1.tuicool.com/AZnm633.png!web" alt=""></p>
<p>In Hector Garcia-Molina’s<a href="http://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf">1987 paper “<em>Sagas</em></a><em>”</em>, he described an approach for solving system failures in a long-running database transactions.</p>
<p>Hector described a Saga as a sequence of related small transactions. In a Saga, the coordinator (database in their case) makes sure that all of the involved transactions are successfully completed. Otherwise, if the transactions fails the coordinator runs compensating transactions to amend the partial execution.</p>
<p>This approach is increasingly relevant in the world of microservices as application logic often needs to transact across multiple bounded contexts — each encapsulated by its own microservice with independent databases.</p>
<p><a href="https://twitter.com/caitie">Caitie McCaffrey</a>recently shared a great presentation that summarizes her experience using the Saga pattern in distributed systems.</p>
<p>During the presentation, Caitie uses the following example set of related transactions — or Saga — to illustrate the pattern.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Begin transaction</div><div class="line">Start book hotel request</div><div class="line">End book hotel request</div><div class="line">Start book flight request</div><div class="line">End book flight request</div><div class="line">Start book car rental request</div><div class="line">End book car rental request</div><div class="line">End transaction</div></pre></td></tr></table></figure>
<p>We can use a Lambda function to model each of the actions — and their compensating actions — and use a state machine in Step Function as the<strong>coordinator</strong>for the saga.</p>
<p><img src="http://img2.tuicool.com/n6Nfieu.png!web" alt=""></p>
<p>Each action and compensating action are modelled as a Lambda function.</p>
<p>Since the compensating actions can also fail, we need to be able to retry them until success — which means they have to be<strong>idempotent</strong>. We’ll also implement<strong>backward recovery</strong>in the event of a system failure.</p>
<p>Below is the state machine that represents our saga. Each of the actions — BookHotel, BookFlight and BookRental — have a compensating action and will be performed in order. The recursive arrows represent that the compensating actions are retried until successful.</p>
<p><img src="http://img0.tuicool.com/fYVvEni.png!web" alt=""></p>
<p>Each Lambda function expects the input to be in the following shape:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">&quot;trip_id&quot;: &quot;5c12d94a-ee6a-40d9-889b-1d49142248b7&quot;,</div><div class="line">&quot;depart&quot;: &quot;London&quot;,</div><div class="line">&quot;depart_at&quot;: &quot;2017-07-10T06:00:00.000Z&quot;,</div><div class="line">&quot;arrive&quot;: &quot;Dublin&quot;,</div><div class="line">&quot;arrive_at&quot;: &quot;2017-07-12T08:00:00.000Z&quot;,</div><div class="line">&quot;hotel&quot;: &quot;holiday inn&quot;,</div><div class="line">&quot;check_in&quot;: &quot;2017-07-10T12:00:00.000Z&quot;,</div><div class="line">&quot;check_out&quot;: &quot;2017-07-12T14:00:00.000Z&quot;,</div><div class="line">&quot;rental&quot;: &quot;Volvo&quot;,</div><div class="line">&quot;rental_from&quot;: &quot;2017-07-10T00:00:00.000Z&quot;,</div><div class="line">&quot;rental_to&quot;: &quot;2017-07-12T00:00:00.000Z&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Inside each of the functions is a simple<code>PutItem</code>request against a different DynamoDB table. The corresponding compensating function will perform a<code>DeleteItem</code>against the corresponding table to rollback the<code>PutItem</code>action.</p>
<p>The state machine pass the same input to each action in turn (Book Hotel → BookFlight → Book Rental) and record their results at a specific path. This will avoid overriding the input<code>$</code>that will be passed to the next function.</p>
<p>In this naive implementation, we’ll apply the compensating action for any failure — hence the<code>State.ALL</code>below. In practice, you should consider giving certain error types a<a href="http://docs.aws.amazon.com/step-functions/latest/dg/amazon-states-language-errors.html#amazon-states-language-retrying-after-error">retry</a>— e.g. temporal errors such as DynamoDB’s provision throughput exceeded exceptions.</p>
<p>The output and error from each action and compensating action are stored at a specific path. This will avoid overriding the input value<code>$</code>for the rest of the actions.</p>
<p><img src="http://img0.tuicool.com/6Rfqymb.png!web" alt=""></p>
<h4 id="The-Happy-Path-Flow"><a href="#The-Happy-Path-Flow" class="headerlink" title="The Happy Path Flow"></a>The Happy Path Flow</h4><p>Following the happy path, each of the actions are performed in turn and the state machine will successfully complete.</p>
<p><img src="http://img0.tuicool.com/36jEz2J.png!web" alt=""></p>
<h4 id="Failure-Cases"><a href="#Failure-Cases" class="headerlink" title="Failure Cases"></a>Failure Cases</h4><p>When failures strike, we need to apply the corresponding compensating actions in turn depending on where the failure occurs.</p>
<p>In the examples below, if the failure happened at<code>BookFlight</code>, then both<code>CancelFlight</code>and<code>CancelHotel</code>will be executed to rollback any changes performed thus far.</p>
<p>Similar, if the failure happened at<code>BookRental</code>, then all three compensating actions —<code>CancelRental</code>,<code>CancelFlight</code>and<code>CancelHotel</code>— will be executed in that order to rollback all the state changes from the transaction.</p>
<p>Each compensating action also have an infinite retry loop! In practice, there should be a reasonable upper limit on the no. of retries before you alert for human intervention.</p>
<p><img src="http://img1.tuicool.com/Jr677be.png!web" alt=""></p>
<p>If you’d like to experiment on your own with the Saga Pattern using this example, the source code for this demo can be found<a href="https://github.com/theburningmonk/lambda-saga-pattern">here</a>.</p>
<p><a href="https://github.com/theburningmonk/lambda-saga-pattern">theburningmonk/lambda-saga-pattern_lambda-saga-pattern - Implementing the Saga pattern for Lambda functions using Step Functions_github.com</a></p>
<p>I’d be interested in your thoughts on the benefits or drawbacks of using the Saga Pattern with microservices architecture … please drop a comment below.<em>Thanks for reading!</em></p>
<p>Source:  <a href="https://read.acloud.guru/how-the-saga-pattern-manages-failures-with-aws-lambda-and-step-functions-bc8f7129f900?gi=1f27b350ff64">https://read.acloud.guru/how-the-saga-pattern-manages-failures-with-aws-lambda-and-step-functions-bc8f7129f900?gi=1f27b350ff64</a></p>

  </div>
  

 <!-- jsSocials -->
<script src="/jssocials-1.4.0/jssocials.min.js"></script>
<link rel="stylesheet" href="/jssocials-1.4.0/jssocials.css">
<link rel="stylesheet" href="/jssocials-1.4.0/jssocials-theme-flat.css">

<div class="socials-share-btn"></div>
<script>
  if ($) {
    $(document).ready(function(){
      $(".socials-share-btn").jsSocials({
        shares: ["email", "twitter", "facebook", "googleplus", "linkedin", "pinterest", "stumbleupon", "whatsapp"]
      });
    })
  }
</script>


  
<section id="comments">
  <div id="disqus_thread"></div>
</section>
<script>
  var disqus_shortname = 'gmagon';
  var disqus_url = 'https://gmagon.com/blog/2017/09/04/how-the-saga-pattern-manages-failures-with-aws-lambda-and-step-functions/index.html';
  var disqus_title = "How the Saga Pattern manages failures with AWS Lambda and Step Functions";
  var disqus_config = function(){
    this.language = 'en';
  };
  (function(){
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'https://go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

  <script src="/js/audios.js"></script>
</article>

          </div>
      
          <aside id="article-toc" role="navigation">
                <div id="article-toc-inner">
                  <strong class="sidebar-title">Contents</strong>
                  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#How-the-Saga-Pattern-manages-failures-with-AWS-Lambda-and-Step-Functions"><span class="toc-text">How the Saga Pattern manages failures with AWS Lambda and Step Functions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#The-Happy-Path-Flow"><span class="toc-text">The Happy Path Flow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Failure-Cases"><span class="toc-text">Failure Cases</span></a></li></ol></li></ol></li></ol></li></ol>
                  <a href="#" id="article-toc-top">Back to Top</a>
                </div>
          </aside>
        </div>
      </article>
    </div>
  </div>
</div>



    <footer id="footer" class="font-e3">
  <div class="inner">
    <div id="footer-some-docs">
        <a href="/terms_conditions.html" class="footer-doc-link" >Terms & Conditions</a>
        <a href="/privacy.html" class="footer-doc-link" >Privacy</a>
        <a href="/end-user-license-agreement.html" class="footer-doc-link" >License Agreement</a>
    </div>
    <div id="footer-copyright">
       <a href="" > Copyright &copy; 2017 Gmagon,Inc. All rights reserved. </a>
    </div>
  </div>

  <div class="inner">
    <div id="footer-links">
        
        <a href="https://twitter.com/gmagonshare" class="footer-link" target="_blank" rel="nofollow me noopener noreferrer" ><i class="fa fa-twitter"></i></a>
        
        <a href="https://www.facebook.com/gmagonshare" class="footer-link" target="_blank" rel="nofollow me noopener noreferrer" ><i class="fa fa-facebook"></i></a>
        <a href="https://www.youtube.com/gmagonshare" class="footer-link" target="_blank" rel="nofollow me noopener noreferrer" ><i class="fa fa-youtube"></i></a>
        <a href="https://www.instagram.com/gmagonshare" class="footer-link" target="_blank" rel="nofollow me noopener noreferrer" ><i class="fa fa-instagram"></i></a>
    </div>
  </div>


  <div class="inner">
    <div id="footer-security">
       <p>
          <img src="/asset/images/security/klogo.png">
          <img src="/asset/images/security/mcafee.png">
          <img src="/asset/images/security/cmmodo_scanned.png">
          <img src="/asset/images/security/softonic_tested.png">
          <img src="/asset/images/security/tested_by_sucuri.png">
          <img src="/asset/images/security/norton.png">
          <img src="/asset/images/security/eset_logo.png">
       </p>
    </div>
  </div>




</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/" class="mobile-nav-link ">Home</a><a href="/products/" class="mobile-nav-link ">Products</a><a href="/guide/" class="mobile-nav-link ">Guide</a><a href="/support/" class="mobile-nav-link ">Support</a><a href="/blog/" class="mobile-nav-link ">Blog</a>
      
    </ul>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>English</span></span>
    <select id="mobile-lang-select" data-canonical="">
      
        <option value="en" selected>English</option>
      
    </select>
  </div>
</nav>

  <!-- Scripts -->
<script src="/build/js/main-8277743eaa.js"></script>
<!-- <script src="https://cdn.jsdelivr.net/retinajs/1.3.0/retina.min.js" async></script> -->

<!-- totop -->
<div id="gmagon_totop" style="position:fixed;bottom:150px;right:30px;cursor: pointer;">
  <a title="Back to top"><img src="/asset/images/scroll-up.png"/></a>
</div>
<script src="/js/totop.js"></script>





<!-- Google Analytics -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  try{
    ga('create', 'UA-99314951-1', 'auto');
    ga('send', 'pageview');
    ga('send', 'https://gmagon.com/blog/2017/09/04/how-the-saga-pattern-manages-failures-with-aws-lambda-and-step-functions/index.html');
    ga('send', 'How the Saga Pattern manages failures with AWS Lambda and Step Functions')
  }catch(e){}

</script>


</body>
</html>