<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8">

  <title>Handwritten Hash Codes are Faster in Java 9 - Gmagon Software - handy and professional Mac apps.</title>

  <meta http-equiv="X-UA-Compatible" content="IE=8; IE=9; IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="robots" content="noodp" />
  <meta name="keywords" content="Handwritten Hash Codes are Faster in Java 9" />
  <meta name="description" content="Handwritten Hash Codes are Faster in Java 9" />

  <!-- Custom config og:image -->


  <!-- Open Graph -->
<meta name="description" content="Handwritten Hash Codes are Faster in Java 9 - Gmagon Software - handy and professional Mac apps.">
<meta property="og:type" content="apps">
<meta property="og:title" content="Handwritten Hash Codes are Faster in Java 9 - Gmagon Software - handy and professional Mac apps.">
<meta property="og:url" content="https://gmagon.com/blog/2017/09/06/handwritten-hash-codes-are-faster-in-java-9/index.html">
<meta property="og:site_name" content="Handwritten Hash Codes are Faster in Java 9 - Gmagon Software - handy and professional Mac apps.">
<meta property="og:description" content="Handwritten Hash Codes are Faster in Java 9 - Gmagon Software - handy and professional Mac apps.">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2017-09-06T08:24:01.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Handwritten Hash Codes are Faster in Java 9 - Gmagon Software - handy and professional Mac apps.">
<meta name="twitter:description" content="Handwritten Hash Codes are Faster in Java 9 - Gmagon Software - handy and professional Mac apps.">
<meta name="twitter:site" content="gmagonshare">
<meta property="fb:admins" content="432634277117208">
<meat name="twitter:url" content="https://gmagon.com/blog/2017/09/06/handwritten-hash-codes-are-faster-in-java-9/index.html">



  <!-- algolia_config -->
  
  
  <!-- Canonical links -->
  <link rel="canonical" href="https://gmagon.com/blog/2017/09/06/handwritten-hash-codes-are-faster-in-java-9/index.html">

  <!-- Alternative links -->
  

  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/icon/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/icon/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/icon/mstile-144x144.png">

  <!-- CSS -->
  <link rel="stylesheet" href="/build/css/navy-7722a083b2.css">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/asset/styles/global.css">
  
  <!-- jQuery -->
  <script src="/js/jquery/jquery-3.2.1.min.js"></script>
<script src="/js/jquery/jquery-migrate-1.4.1.min.js"></script>



  <!-- ForPostLayout -->
  
    
    
  
  <!-- endForPostLayout -->

  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="Gmagon Software - handy and professional Mac apps.">

  <!-- algolia_search -->
  <script src="/assets/algolia/algoliasearchLite.min.js" async></script>

  <!-- Utils -->
<script src="/js/utils.js"></script>
</head>

<body>
  <div id="container">
    <header id="header">
  <div class="wrapper">
    <div id="header-inner" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Gmagon Software - handy and professional Mac apps.</a>
        <span>gmagon </span>
      </h1>
      <nav id="main-nav">
        <a href="/" class="main-nav-link ">Home</a><a href="/products/" class="main-nav-link ">Products</a><a href="/guide/" class="main-nav-link ">Guide</a><a href="/support/" class="main-nav-link ">Support</a><a href="/blog/" class="main-nav-link ">Blog</a>
        <div id="search-input-wrap">
          <a href="/search/" class="text-decoration-none ">
            <div id="search-input-icon">
              <i class="fa fa-search"></i>
            </div>
          </a>
        </div>
      </nav>
      <div id="lang-select-wrap">
        <label id="lang-select-label"><i class="fa fa-globe"></i><span>English</span></label>
        <select id="lang-select" data-canonical="">
          
            <option value="en" selected>English</option>
          
        </select>
      </div>
      <a id="mobile-nav-toggle">
        <span class="mobile-nav-toggle-bar"></span>
        <span class="mobile-nav-toggle-bar"></span>
        <span class="mobile-nav-toggle-bar"></span>
      </a>
    </div>
  </div>  
</header>
<div class="hide-wrap-head-top"></div>
    <div class="class-content-wrap">
  <div class="inner">
    <div class="inner-wrap fill-bunting font-e3">
      <h2 id="banner-title"> Handwritten Hash Codes are Faster in Java 9 </h2>
      <div id="banner-start">
        <a class="btn btn-static-secondary btn-shadow" href="https://gitter.im/Gmagon/support" ttarget="_blank" rel="nofollow me noopener noreferrer" >Need help?</a>
      </div>
    </div>
  </div>
</div>

<div class="class-content-wrap">
  <div class="wrapper">
    <div class="inner">
      <article class="article-container" itemscope itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
          <div class="hide-wrap-head-top"></div>
<article class="article post" itemscope itemtype="http://schema.org/Article">
  <header class="article-header">
    
      <h1 class="article-title" itemprop="name">Handwritten Hash Codes are Faster in Java 9</h1>
    
    <a href="/blog/2017/09/06/handwritten-hash-codes-are-faster-in-java-9/" class="article-date"><time datetime="2017-09-06T00:00:00.000Z">2017-09-06</time></a>
  </header>
  <div class="article-content" itemprop="articleBody">
    
    <div class="post-authors">
      <table class="app-download-table"> 
      <thead> 
        <tr> 
        <th>Article Media</th> 
        <th>Links</th> 
        </tr> 
      </thead> 
      <tbody> 
        <tr> 
        <td class="app-download-version">FaceBook</td> 
        <td class="on elevation1"><a href="https://www.facebook.com/groups/winandmac">https://www.facebook.com/groups/winandmac </a></td> 
        </tr> 
        <tr> 
        <td class="app-download-version">Twitter</td> 
        <td class="on elevation1"><a href="https://twitter.com/gmagonshare">https://twitter.com/gmagonshare </a></td> 
        </tr> 
      </tbody> 
      </table>
    </div>
    <p>Update 05/09/2017: I have recently discovered that this phenomenon was first described by Alexey Shipilev on an<a href="https://bugs.openjdk.java.net/browse/JDK-8059113">OpenJDK ticket</a>in 2014. As Alexey notes, this is due to the strength reduction of a multiplication by 31 to a shift and a subtraction, which creates a data dependency preventing an unroll. You can see the assembly emitted, confirming this data dependency, in the comments of this post.</p>
<p>One of the things to keep in mind with Java is that the best performance advice for one version may not apply to the next. The JVM has an optimiser which works by detecting intent in byte-code; it does a better job when the programmer is skilled enough to make that intent clear. There have been times when the optimiser has done a bad job, either through bugs or feature gaps, and compensatory idioms emerge. The value of these idioms degrades over time as the optimiser improves; a stroke of ingenuity in one version can become ritualistic nonsense in the next. It’s important not to be_that guy_who fears adding strings together because it was costly a decade ago, but does it always get better, even with low hanging fruit?</p>
<p>I reproduced the results of an <a href="http://lemire.me/blog/2015/10/22/faster-hashing-without-effort/">extremely astute optimisation</a> presented in 2015 by Daniel Lemire. I was hoping to see that an improved optimiser in Java 9, having observed several cases of automatic vectorisation, would render this optimisation null.</p>
<h3 id="Hash-Codes-for-Arrays"><a href="#Hash-Codes-for-Arrays" class="headerlink" title="Hash Codes for Arrays"></a>Hash Codes for Arrays</h3><p>I encourage you to read the <a href="http://lemire.me/blog/2015/10/22/faster-hashing-without-effort/">original blog post</a> because it is informative, but for the sake of coherence I will summarise the key point here.<code>Arrays.hashCode</code>implements the following hash code:</p>
<p>public static int hashCode(int[] a) {<br>if (a == null)<br>return 0;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">int result = 1;</div><div class="line">for (int element : a)</div><div class="line">result = 31 * result + element;</div><div class="line"></div><div class="line">return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>This results in a good hash code, but a scalar internal representation of this code has a problem: a data dependency on the multiplication, which is slower than moving data into registers. A significant and reproducible speed up can be observed when unrolling the loop, which enforces a prefetch of 128 bits of the array into registers before doing the slower multiplications:</p>
<p>public static int hashCode(int[] a) {<br>if (a == null)<br>return 0;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">int result = 1;</div><div class="line">int i = 0;</div><div class="line">for (; i + 3 &lt; a.length; i += 4) &#123;</div><div class="line">result = 31 * 31 * 31 * 31 * result</div><div class="line">+ 31 * 31 * 31 * a[i]</div><div class="line">+ 31 * 31 * a[i + 1]</div><div class="line">+ 31 * a[i + 2]</div><div class="line">+ a[i + 3];</div><div class="line">&#125;</div><div class="line">for (; i &lt; a.length; i++) &#123;</div><div class="line">result = 31 * result + a[i];</div><div class="line">&#125;</div><div class="line">return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The improvement in performance from this simple change can be confirmed with Java 8 by running a simple benchmark.</p>
<table>
<thead>
<tr>
<th style="text-align:left">BENCHMARK</th>
<th style="text-align:left">MODE</th>
<th style="text-align:left">THREADS</th>
<th style="text-align:left">SAMPLES</th>
<th style="text-align:left">SCORE</th>
<th style="text-align:left">SCORE ERROR (99.9%)</th>
<th style="text-align:left">UNIT</th>
<th style="text-align:left">PARAM: SIZE</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">BuiltIn</td>
<td style="text-align:left">thrpt</td>
<td style="text-align:left">1</td>
<td style="text-align:left">10</td>
<td style="text-align:left">9.537736</td>
<td style="text-align:left">0.382617</td>
<td style="text-align:left">ops/us</td>
<td style="text-align:left">100</td>
</tr>
<tr>
<td style="text-align:left">BuiltIn</td>
<td style="text-align:left">thrpt</td>
<td style="text-align:left">1</td>
<td style="text-align:left">10</td>
<td style="text-align:left">0.804620</td>
<td style="text-align:left">0.103037</td>
<td style="text-align:left">ops/us</td>
<td style="text-align:left">1000</td>
</tr>
<tr>
<td style="text-align:left">BuiltIn</td>
<td style="text-align:left">thrpt</td>
<td style="text-align:left">1</td>
<td style="text-align:left">10</td>
<td style="text-align:left">0.092297</td>
<td style="text-align:left">0.003947</td>
<td style="text-align:left">ops/us</td>
<td style="text-align:left">10000</td>
</tr>
<tr>
<td style="text-align:left">Unrolled</td>
<td style="text-align:left">thrpt</td>
<td style="text-align:left">1</td>
<td style="text-align:left">10</td>
<td style="text-align:left">14.974398</td>
<td style="text-align:left">0.628522</td>
<td style="text-align:left">ops/us</td>
<td style="text-align:left">100</td>
</tr>
<tr>
<td style="text-align:left">Unrolled</td>
<td style="text-align:left">thrpt</td>
<td style="text-align:left">1</td>
<td style="text-align:left">10</td>
<td style="text-align:left">1.514986</td>
<td style="text-align:left">0.035759</td>
<td style="text-align:left">ops/us</td>
<td style="text-align:left">1000</td>
</tr>
<tr>
<td style="text-align:left">Unrolled</td>
<td style="text-align:left">thrpt</td>
<td style="text-align:left">1</td>
<td style="text-align:left">10</td>
<td style="text-align:left">0.137408</td>
<td style="text-align:left">0.010200</td>
<td style="text-align:left">ops/us</td>
<td style="text-align:left">10000</td>
</tr>
</tbody>
</table>
<p>The performance improvement is so obvious, and the change so easy to make, that one wonders why JVM vendors didn’t make the change themselves.</p>
<h3 id="Java-9-Universally-Better-Automatic-Optimisations"><a href="#Java-9-Universally-Better-Automatic-Optimisations" class="headerlink" title="Java 9: Universally Better Automatic Optimisations?"></a>Java 9: Universally Better Automatic Optimisations?</h3><p>As the comments on the blog post suggest, this is a prime candidate for vectorisation. Auto-vectorisation is a_thing_in Java 9. Using intrinsics or code clean enough to express intent clearly, you can really expect to see good usage of SIMD in Java 9. I was really expecting the situation to reverse in Java 9; but it doesn’t.</p>
<table>
<thead>
<tr>
<th style="text-align:left">BENCHMARK</th>
<th style="text-align:left">MODE</th>
<th style="text-align:left">THREADS</th>
<th style="text-align:left">SAMPLES</th>
<th style="text-align:left">SCORE</th>
<th style="text-align:left">SCORE ERROR (99.9%)</th>
<th style="text-align:left">UNIT</th>
<th style="text-align:left">PARAM: SIZE</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">BuiltIn</td>
<td style="text-align:left">thrpt</td>
<td style="text-align:left">1</td>
<td style="text-align:left">10</td>
<td style="text-align:left">9.822568</td>
<td style="text-align:left">0.381087</td>
<td style="text-align:left">ops/us</td>
<td style="text-align:left">100</td>
</tr>
<tr>
<td style="text-align:left">BuiltIn</td>
<td style="text-align:left">thrpt</td>
<td style="text-align:left">1</td>
<td style="text-align:left">10</td>
<td style="text-align:left">0.949273</td>
<td style="text-align:left">0.024021</td>
<td style="text-align:left">ops/us</td>
<td style="text-align:left">1000</td>
</tr>
<tr>
<td style="text-align:left">BuiltIn</td>
<td style="text-align:left">thrpt</td>
<td style="text-align:left">1</td>
<td style="text-align:left">10</td>
<td style="text-align:left">0.093171</td>
<td style="text-align:left">0.004502</td>
<td style="text-align:left">ops/us</td>
<td style="text-align:left">10000</td>
</tr>
<tr>
<td style="text-align:left">Unrolled</td>
<td style="text-align:left">thrpt</td>
<td style="text-align:left">1</td>
<td style="text-align:left">10</td>
<td style="text-align:left">13.762617</td>
<td style="text-align:left">0.440135</td>
<td style="text-align:left">ops/us</td>
<td style="text-align:left">100</td>
</tr>
<tr>
<td style="text-align:left">Unrolled</td>
<td style="text-align:left">thrpt</td>
<td style="text-align:left">1</td>
<td style="text-align:left">10</td>
<td style="text-align:left">1.501106</td>
<td style="text-align:left">0.094897</td>
<td style="text-align:left">ops/us</td>
<td style="text-align:left">1000</td>
</tr>
<tr>
<td style="text-align:left">Unrolled</td>
<td style="text-align:left">thrpt</td>
<td style="text-align:left">1</td>
<td style="text-align:left">10</td>
<td style="text-align:left">0.139963</td>
<td style="text-align:left">0.011487</td>
<td style="text-align:left">ops/us</td>
<td style="text-align:left">10000</td>
</tr>
</tbody>
</table>
<p>This is a still a smart optimisation two years later, but it offends my sensibilities in the same way hints do in SQL – a layer of abstraction has been punctured. I will have to try again in Java 10.</p>
<p>Source: <a href="https://richardstartin.com/2017/07/23/still-true-in-java-9-handwritten-hash-codes-are-faster/">https://richardstartin.com/2017/07/23/still-true-in-java-9-handwritten-hash-codes-are-faster/</a></p>

  </div>
  

 <!-- jsSocials -->
<script src="/jssocials-1.4.0/jssocials.min.js"></script>
<link rel="stylesheet" href="/jssocials-1.4.0/jssocials.css">
<link rel="stylesheet" href="/jssocials-1.4.0/jssocials-theme-flat.css">

<div class="socials-share-btn"></div>
<script>
  if ($) {
    $(document).ready(function(){
      $(".socials-share-btn").jsSocials({
        shares: ["email", "twitter", "facebook", "googleplus", "linkedin", "pinterest", "stumbleupon", "whatsapp"]
      });
    })
  }
</script>


  
<section id="comments">
  <div id="disqus_thread"></div>
</section>
<script>
  var disqus_shortname = 'gmagon';
  var disqus_url = 'https://gmagon.com/blog/2017/09/06/handwritten-hash-codes-are-faster-in-java-9/index.html';
  var disqus_title = "Handwritten Hash Codes are Faster in Java 9";
  var disqus_config = function(){
    this.language = 'en';
  };
  (function(){
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'https://go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

  <script src="/js/audios.js"></script>
</article>

          </div>
      
          <aside id="article-toc" role="navigation">
                <div id="article-toc-inner">
                  <strong class="sidebar-title">Contents</strong>
                  <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hash-Codes-for-Arrays"><span class="toc-text">Hash Codes for Arrays</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-9-Universally-Better-Automatic-Optimisations"><span class="toc-text">Java 9: Universally Better Automatic Optimisations?</span></a></li></ol>
                  <a href="#" id="article-toc-top">Back to Top</a>
                </div>
          </aside>
        </div>
      </article>
    </div>
  </div>
</div>



    <footer id="footer" class="font-e3">
  <div class="inner">
    <div id="footer-some-docs">
        <a href="/terms_conditions.html" class="footer-doc-link" >Terms & Conditions</a>
        <a href="/privacy.html" class="footer-doc-link" >Privacy</a>
        <a href="/end-user-license-agreement.html" class="footer-doc-link" >License Agreement</a>
    </div>
    <div id="footer-copyright">
       <a href="" > Copyright &copy; 2017 Gmagon,Inc. All rights reserved. </a>
    </div>
  </div>

  <div class="inner">
    <div id="footer-links">
        
        <a href="https://twitter.com/gmagonshare" class="footer-link" target="_blank" rel="nofollow me noopener noreferrer" ><i class="fa fa-twitter"></i></a>
        
        <a href="https://www.facebook.com/gmagonshare" class="footer-link" target="_blank" rel="nofollow me noopener noreferrer" ><i class="fa fa-facebook"></i></a>
        <a href="https://www.youtube.com/gmagonshare" class="footer-link" target="_blank" rel="nofollow me noopener noreferrer" ><i class="fa fa-youtube"></i></a>
        <a href="https://www.instagram.com/gmagonshare" class="footer-link" target="_blank" rel="nofollow me noopener noreferrer" ><i class="fa fa-instagram"></i></a>
    </div>
  </div>


  <div class="inner">
    <div id="footer-security">
       <p>
          <img src="/asset/images/security/klogo.png">
          <img src="/asset/images/security/mcafee.png">
          <img src="/asset/images/security/cmmodo_scanned.png">
          <img src="/asset/images/security/softonic_tested.png">
          <img src="/asset/images/security/tested_by_sucuri.png">
          <img src="/asset/images/security/norton.png">
          <img src="/asset/images/security/eset_logo.png">
       </p>
    </div>
  </div>




</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/" class="mobile-nav-link ">Home</a><a href="/products/" class="mobile-nav-link ">Products</a><a href="/guide/" class="mobile-nav-link ">Guide</a><a href="/support/" class="mobile-nav-link ">Support</a><a href="/blog/" class="mobile-nav-link ">Blog</a>
      
    </ul>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>English</span></span>
    <select id="mobile-lang-select" data-canonical="">
      
        <option value="en" selected>English</option>
      
    </select>
  </div>
</nav>

  <!-- Scripts -->
<script src="/build/js/main-8277743eaa.js"></script>
<!-- <script src="https://cdn.jsdelivr.net/retinajs/1.3.0/retina.min.js" async></script> -->

<!-- totop -->
<div id="gmagon_totop" style="position:fixed;bottom:150px;right:30px;cursor: pointer;">
  <a title="Back to top"><img src="/asset/images/scroll-up.png"/></a>
</div>
<script src="/js/totop.js"></script>





<!-- Google Analytics -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  try{
    ga('create', 'UA-99314951-1', 'auto');
    ga('send', 'pageview');
    ga('send', 'https://gmagon.com/blog/2017/09/06/handwritten-hash-codes-are-faster-in-java-9/index.html');
    ga('send', 'Handwritten Hash Codes are Faster in Java 9')
  }catch(e){}

</script>


</body>
</html>