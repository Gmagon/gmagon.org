<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8">

  <title>May your Makefiles be portable - Gmagon Software - handy and professional Mac apps.</title>

  <meta http-equiv="X-UA-Compatible" content="IE=8; IE=9; IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="robots" content="noodp" />
  <meta name="keywords" content="May your Makefiles be portable" />
  <meta name="description" content="May your Makefiles be portable" />

  <!-- Custom config og:image -->


  <!-- Open Graph -->
<meta name="description" content="May your Makefiles be portable - Gmagon Software - handy and professional Mac apps.">
<meta property="og:type" content="apps">
<meta property="og:title" content="May your Makefiles be portable - Gmagon Software - handy and professional Mac apps.">
<meta property="og:url" content="https://gmagon.com/blog/2017/08/21/may-your-makefiles-be-portable/index.html">
<meta property="og:site_name" content="May your Makefiles be portable - Gmagon Software - handy and professional Mac apps.">
<meta property="og:description" content="May your Makefiles be portable - Gmagon Software - handy and professional Mac apps.">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://img1.tuicool.com/UrQJrqE.png!web">
<meta property="og:updated_time" content="2017-08-21T12:16:55.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="May your Makefiles be portable - Gmagon Software - handy and professional Mac apps.">
<meta name="twitter:description" content="May your Makefiles be portable - Gmagon Software - handy and professional Mac apps.">
<meta name="twitter:image" content="http://img1.tuicool.com/UrQJrqE.png!web">
<meta name="twitter:site" content="gmagonshare">
<meta property="fb:admins" content="432634277117208">
<meat name="twitter:url" content="https://gmagon.com/blog/2017/08/21/may-your-makefiles-be-portable/index.html">



  <!-- algolia_config -->
  
  
  <!-- Canonical links -->
  <link rel="canonical" href="https://gmagon.com/blog/2017/08/21/may-your-makefiles-be-portable/index.html">

  <!-- Alternative links -->
  

  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/icon/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/icon/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/icon/mstile-144x144.png">

  <!-- CSS -->
  <link rel="stylesheet" href="/build/css/navy-a395c8a81d.css">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  
  <!-- jQuery -->
  <script src="/js/jquery/jquery-3.2.1.min.js"></script>
<script src="/js/jquery/jquery-migrate-1.4.1.min.js"></script>



  <!-- ForPostLayout -->
  
    
    
  
  <!-- endForPostLayout -->

  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="Gmagon Software - handy and professional Mac apps.">

  <!-- algolia_search -->
  <script src="/assets/algolia/algoliasearchLite.min.js" async></script>

  <!-- Github Button -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  <!-- Utils -->
<script src="/js/utils.js"></script>
</head>

<body>
  <div id="container">
    <header id="header">
  <div class="wrapper">
    <div id="header-inner" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Gmagon Software - handy and professional Mac apps.</a>
        <span>gmagon </span>
      </h1>
      <nav id="main-nav">
        <a href="/" class="main-nav-link ">Home</a><a href="/products/" class="main-nav-link ">Products</a><a href="/guide/" class="main-nav-link ">Guide</a><a href="/support/" class="main-nav-link ">Support</a><a href="/blog/" class="main-nav-link ">Blog</a>
        <div id="search-input-wrap">
          <a href="/search/" class="text-decoration-none">
            <div id="search-input-icon">
              <i class="fa fa-search"></i>
            </div>
          </a>
        </div>
      </nav>
      <div id="lang-select-wrap">
        <label id="lang-select-label"><i class="fa fa-globe"></i><span>English</span></label>
        <select id="lang-select" data-canonical="">
          
            <option value="en" selected>English</option>
          
        </select>
      </div>
      <a id="mobile-nav-toggle">
        <span class="mobile-nav-toggle-bar"></span>
        <span class="mobile-nav-toggle-bar"></span>
        <span class="mobile-nav-toggle-bar"></span>
      </a>
    </div>
  </div>  
</header>
<div class="hide-wrap-head-top"></div>

    <div class="class-content-wrap">
  <div class="inner">
    <div class="inner-wrap fill-bunting font-e3">
      <h2 id="banner-title"> May your Makefiles be portable </h2>
      <div id="banner-start">
        <a class="btn btn-static-secondary btn-shadow" href="https://gitter.im/Gmagon/support" ttarget="_blank" rel="nofollow me noopener noreferrer" >Need help?</a>
      </div>
    </div>
  </div>
</div>

<div class="class-content-wrap">
  <div class="wrapper">
    <div class="inner">
      <article class="article-container" itemscope itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
          <div class="hide-wrap-head-top"></div>
<article class="article post" itemscope itemtype="http://schema.org/Article">
  <header class="article-header">
    
      <h1 class="article-title" itemprop="name">May your Makefiles be portable</h1>
    
    <a href="/blog/2017/08/21/may-your-makefiles-be-portable/" class="article-date"><time datetime="2017-08-21T00:00:00.000Z">2017-08-21</time></a>
  </header>
  <div class="article-content" itemprop="articleBody">
    <p>In my first decade writing Makefiles, I developed the bad habit of liberally using GNU Make’s extensions. I didn’t know the line between GNU Make and the portable features guaranteed by POSIX. Usually it didn’t matter much, but it would become an annoyance when building on non-Linux systems, such as on the various BSDs. I’d have to specifically install GNU Make, then remember to invoke it (i.e. as<code>gmake</code>) instead of the system’s make.</p>
<p>I’ve since become familiar and comfortable with<a href="http://pubs.opengroup.org/onlinepubs/009695399/utilities/make.html">make’s official specification</a>, and I’ve spend the last year writing strictly portable Makefiles. Not only has are my builds now portable across all unix-like systems, my Makefiles are cleaner and more robust. Many of the common make extensions — conditionals in particular — lead to fragile, complicated Makefiles and are best avoided anyway. It’s important to be able to trust your build system to do its job correctly.</p>
<p>This tutorial should be suitable for make beginners who have never written their own Makefiles before, as well as experienced developers who want to learn how to write portable Makefiles.Regardless, in order to understand the examples you must be familiar with the usual steps for building programs on the command line (compiler, linker, object files, etc.). I’m not going to suggest any fancy tricks nor provide any sort of standard starting template. Makefiles should be dead simple when the project is small, and grow in a predictable, clean fashion alongside the project.</p>
<p>I’m not going to cover every feature. You’ll need to read the specification for yourself to learn it all. This tutorial will go over the important features as well as the common conventions. It’s important to follow established conventions so that people using your Makefiles will know what to expect and how to accomplish the basic tasks.</p>
<p>If you’re running Debian, or a Debian derivative such as Ubuntu, the<code>bmake</code>and<code>freebsd-buildutils</code>packages will provide the<code>bmake</code>and<code>fmake</code>programs respectively. These alternative make implementations are very useful for testing your Makefiles’ portability, should you accidentally make use of a GNU Make feature. It’s not perfect since each implements some of the same extensions as GNU Make, but it will catch some common mistakes.</p>
<h3 id="What’s-in-a-Makefile"><a href="#What’s-in-a-Makefile" class="headerlink" title="What’s in a Makefile?"></a>What’s in a Makefile?</h3><p>I am free, no matter what rules surround me. If I find them tolerable, I tolerate them; if I find them too obnoxious, I break them. I am free because I know that I alone am morally responsible for everything I do. ―Robert A. Heinlein</p>
<p>At make’s core are one or more dependency trees, constructed from<em>rules</em>. Each vertex in the tree is called a<em>target</em>. The final products of the build (executable, document, etc.) are the tree roots. A Makefile specifies the dependency trees and supplies the shell commands to produce a target from its<em>prerequisites</em>.</p>
<p><img src="http://img1.tuicool.com/UrQJrqE.png!web" alt=""></p>
<p>In this illustration, the “.c” files are source files that are written by hand, not generated by commands, so they have no prerequisites. The syntax for specifying one or more edges in this dependency tree is simple:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">target</div><div class="line">[target...]</div><div class="line">: </div><div class="line">[prerequisite...]</div></pre></td></tr></table></figure>
<p>While technically multiple targets can be specified in a single rule, this is unusual. Typically each target is specified in its own rule. To specify the tree in the illustration above:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">game</div><div class="line">: </div><div class="line">graphics</div><div class="line">.o</div><div class="line">physics</div><div class="line">.o</div><div class="line">input</div><div class="line">.o</div><div class="line">graphics</div><div class="line">.o</div><div class="line">: </div><div class="line">graphics</div><div class="line">.c</div><div class="line">physics</div><div class="line">.o</div><div class="line">: </div><div class="line">physics</div><div class="line">.c</div><div class="line">input</div><div class="line">.o</div><div class="line">: </div><div class="line">input</div><div class="line">.c</div></pre></td></tr></table></figure>
<p>The order of these rules doesn’t matter. The entire Makefile is parsed before any actions are taken, so the tree’s vertices and edges can be specified in any order. There’s one exception: the first non-special target in a Makefile is the<em>default target</em>. This target is selected implicitly when make is invoked without choosing a target. It should be something sensible, so that a user can blindly run make and get a useful result.</p>
<p>A target can be specified more than once. Any new prerequisites are appended to the previously-given prerequisites. For example, this Makefile is identical to the previous, though it’s typically not written this way:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">game</div><div class="line">: </div><div class="line">graphics</div><div class="line">.o</div><div class="line">game</div><div class="line">: </div><div class="line">physics</div><div class="line">.o</div><div class="line">game</div><div class="line">: </div><div class="line">input</div><div class="line">.o</div><div class="line">graphics</div><div class="line">.o</div><div class="line">: </div><div class="line">graphics</div><div class="line">.c</div><div class="line">physics</div><div class="line">.o</div><div class="line">: </div><div class="line">physics</div><div class="line">.c</div><div class="line">input</div><div class="line">.o</div><div class="line">: </div><div class="line">input</div><div class="line">.c</div></pre></td></tr></table></figure>
<p>There are six_special targets_that are used to change the behavior of make itself. All have uppercase names and start with a period. Names fitting this pattern are reserved for use by make. According to the standard, in order to get reliable POSIX behavior, the first target of the Makefile_must_be<code>.POSIX</code>. Since this is a special target, it’s not a candidate for the default target, so<code>game</code>will remain the default target:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.POSIX</div><div class="line">:</div><div class="line"></div><div class="line">game</div><div class="line">: </div><div class="line">graphics</div><div class="line">.o</div><div class="line">physics</div><div class="line">.o</div><div class="line">input</div><div class="line">.o</div><div class="line">graphics</div><div class="line">.o</div><div class="line">: </div><div class="line">graphics</div><div class="line">.c</div><div class="line">physics</div><div class="line">.o</div><div class="line">: </div><div class="line">physics</div><div class="line">.c</div><div class="line">input</div><div class="line">.o</div><div class="line">: </div><div class="line">input</div><div class="line">.c</div></pre></td></tr></table></figure>
<p>In practice, even a simple program will have header files, and sources that include a header file should also have an edge on the dependency tree for it. If the header file changes, targets that include it should also be rebuilt.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.POSIX</div><div class="line">:</div><div class="line"></div><div class="line">game</div><div class="line">: </div><div class="line">graphics</div><div class="line">.o</div><div class="line">physics</div><div class="line">.o</div><div class="line">input</div><div class="line">.o</div><div class="line">graphics</div><div class="line">.o</div><div class="line">: </div><div class="line">graphics</div><div class="line">.c</div><div class="line">graphics</div><div class="line">.h</div><div class="line">physics</div><div class="line">.o</div><div class="line">: </div><div class="line">physics</div><div class="line">.c</div><div class="line">physics</div><div class="line">.h</div><div class="line">input</div><div class="line">.o</div><div class="line">: </div><div class="line">input</div><div class="line">.c</div><div class="line">input</div><div class="line">.h</div><div class="line">graphics</div><div class="line">.h</div><div class="line">physics</div><div class="line">.h</div></pre></td></tr></table></figure>
<h3 id="Adding-commands-to-rules"><a href="#Adding-commands-to-rules" class="headerlink" title="Adding commands to rules"></a>Adding commands to rules</h3><p>We’ve constructed a dependency tree, but we still haven’t told make how to actually build any targets from its prerequisites. The rules also need to specify the shell commands that produce a target from its prerequisites.</p>
<p>If you were to create the source files in the example and invoke make, you will find that it actually_does_know how to build the object files. This is because make is initially configured with certain<em>inference rules</em>, a topic which will be covered later. For now, we’ll add the<code>.SUFFIXES</code>special target to the top, erasing all the built-in inference rules.</p>
<p>Commands immediately follow the target/prerequisite line in a rule. Each command line must start with a tab character. This can be awkward if your text editor isn’t configured for it, and it will be awkward if you try to copy the examples from this page.</p>
<p>Each line is run in its own shell, so be mindful of using commands like<code>cd</code>, which won’t affect later lines.</p>
<p>The simplest thing to do is literally specify the same commands you’d type at the shell:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.POSIX</div><div class="line">:</div><div class="line"></div><div class="line">.SUFFIXES</div><div class="line">:</div><div class="line"></div><div class="line">game</div><div class="line">: </div><div class="line">graphics</div><div class="line">.o</div><div class="line">physics</div><div class="line">.o</div><div class="line">input</div><div class="line">.o</div><div class="line">cc</div><div class="line">-o</div><div class="line">game</div><div class="line">graphics</div><div class="line">.o</div><div class="line">physics</div><div class="line">.o</div><div class="line">input</div><div class="line">.o</div><div class="line">graphics</div><div class="line">.o</div><div class="line">: </div><div class="line">graphics</div><div class="line">.c</div><div class="line">graphics</div><div class="line">.h</div><div class="line">cc</div><div class="line">-c</div><div class="line">graphics</div><div class="line">.c</div><div class="line">physics</div><div class="line">.o</div><div class="line">: </div><div class="line">physics</div><div class="line">.c</div><div class="line">physics</div><div class="line">.h</div><div class="line">cc</div><div class="line">-c</div><div class="line">physics</div><div class="line">.c</div><div class="line">input</div><div class="line">.o</div><div class="line">: </div><div class="line">input</div><div class="line">.c</div><div class="line">input</div><div class="line">.h</div><div class="line">graphics</div><div class="line">.h</div><div class="line">physics</div><div class="line">.h</div><div class="line">cc</div><div class="line">-c</div><div class="line">input</div><div class="line">.c</div></pre></td></tr></table></figure>
<h3 id="Invoking-make-and-choosing-targets"><a href="#Invoking-make-and-choosing-targets" class="headerlink" title="Invoking make and choosing targets"></a>Invoking make and choosing targets</h3><p>I tried to walk into Target, but I missed. ―Mitch Hedberg</p>
<p>When invoking make, it accepts zero or more targets from the dependency tree, and it will build these targets — e.g. run the commands in the target’s rule — if the target is<em>out-of-date</em>. A target is out-of-date if it is older than any of its prerequisites.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># build the &quot;game&quot; binary (default target)</div><div class="line"></div><div class="line">$ make</div><div class="line"></div><div class="line"></div><div class="line"># build just the object files</div><div class="line"></div><div class="line">$ make graphics.o physics.o input.o</div></pre></td></tr></table></figure>
<p>This effect cascades up the dependency tree and causes further targets to be rebuilt until all of the requested targets are up-to-date. There’s a lot of room for parallelism since different branches of the tree can be updated independently. It’s common for make implementations to support parallel builds with the<code>-j</code>option. This is non-standard, but it’s a fantastic feature that doesn’t require anything special in the Makefile to work correctly.</p>
<p>Similar to parallel builds is make’s<code>-k</code>(“keep going”) option, which_is_standard. This tells make not to stop on the first error, and to continue updating targets that are unaffected by the error. This is nice for fully populating<a href="http://vimdoc.sourceforge.net/htmldoc/quickfix.html">Vim’s quickfix list</a>or<a href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Compilation.html">Emacs’ compilation buffer</a>.</p>
<p>It’s common to have multiple targets that should be built by default. If the first rule selects the default target, how do we solve the problem of needing multiple default targets? The convention is to use<em>phony targets</em>. These are called “phony” because there is no corresponding file, and so phony targets are never up-to-date. It’s convention for a phony “all” target to be the default target.</p>
<p>I’ll make<code>game</code>a prerequisite of a new “all” target. More real targets could be added as necessary to turn them into defaults. Users of this Makefile will also expect<code>make all</code>to build the entire project.</p>
<p>Another common phony target is “clean” which removes all of the built files. Users will expect<code>make clean</code>to delete all generated files.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.POSIX</div><div class="line">:</div><div class="line"></div><div class="line">.SUFFIXES</div><div class="line">:</div><div class="line"></div><div class="line">all</div><div class="line">: </div><div class="line">game</div><div class="line">game</div><div class="line">: </div><div class="line">graphics</div><div class="line">.o</div><div class="line">physics</div><div class="line">.o</div><div class="line">input</div><div class="line">.o</div><div class="line">cc</div><div class="line">-o</div><div class="line">game</div><div class="line">graphics</div><div class="line">.o</div><div class="line">physics</div><div class="line">.o</div><div class="line">input</div><div class="line">.o</div><div class="line">graphics</div><div class="line">.o</div><div class="line">: </div><div class="line">graphics</div><div class="line">.c</div><div class="line">graphics</div><div class="line">.h</div><div class="line">cc</div><div class="line">-c</div><div class="line">graphics</div><div class="line">.c</div><div class="line">physics</div><div class="line">.o</div><div class="line">: </div><div class="line">physics</div><div class="line">.c</div><div class="line">physics</div><div class="line">.h</div><div class="line">cc</div><div class="line">-c</div><div class="line">physics</div><div class="line">.c</div><div class="line">input</div><div class="line">.o</div><div class="line">: </div><div class="line">input</div><div class="line">.c</div><div class="line">input</div><div class="line">.h</div><div class="line">graphics</div><div class="line">.h</div><div class="line">physics</div><div class="line">.h</div><div class="line">cc</div><div class="line">-c</div><div class="line">input</div><div class="line">.c</div><div class="line">clean</div><div class="line">:</div><div class="line">    </div><div class="line">rm</div><div class="line">-f</div><div class="line">game</div><div class="line">graphics</div><div class="line">.o</div><div class="line">physics</div><div class="line">.o</div><div class="line">input</div><div class="line">.o</div></pre></td></tr></table></figure>
<h3 id="Customize-the-build-with-macros"><a href="#Customize-the-build-with-macros" class="headerlink" title="Customize the build with macros"></a>Customize the build with macros</h3><p>So far the Makefile hardcodes<code>cc</code>as the compiler, and doesn’t use any compiler flags (warnings, optimization, hardening, etc.). The user should be able to easily control all these things, but right now they’d have to edit the entire Makefile to do so. Perhaps the user has both<code>gcc</code>and<code>clang</code>installed, and wants to choose one or the other without changing which is installed as<code>cc</code>.</p>
<p>To solve this, make has_macros_that expand into strings when referenced. The convention is to use the macro named<code>CC</code>when talking about the C compiler,<code>CFLAGS</code>when talking about flags passed to the C compiler,<code>LDFLAGS</code>for flags passed to the C compiler when linking, and<code>LDLIBS</code>for flags about libraries when linking. The Makefile should supply defaults as needed.</p>
<p>A macro is expanded with<code>$(...)</code>. It’s valid (and normal) to reference a macro that hasn’t been defined, which will be an empty string. This will be the case with<code>LDFLAGS</code>below.</p>
<p>Macro values can contain other macros, which will be expanded recursively each time the macro is expanded. Some make implementations allow the name of the macro being expanded to itself be a macro, whichis turing complete, but this behavior is non-standard.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">CC     = </div><div class="line">cc</div><div class="line"></div><div class="line">CFLAGS = -W -O</div><div class="line">LDLIBS = -</div><div class="line">lm</div><div class="line"></div><div class="line"></div><div class="line">.POSIX:</div><div class="line">.SUFFIXES:</div><div class="line"></div><div class="line">al</div><div class="line">l:</div><div class="line"> game</div><div class="line">game: graphics.</div><div class="line">o</div><div class="line"> physics.</div><div class="line">o</div><div class="line">input</div><div class="line">.</div><div class="line">o</div><div class="line"></div><div class="line">    $(CC) $(LDFLAGS) -</div><div class="line">o</div><div class="line"> game graphics.</div><div class="line">o</div><div class="line"> physics.</div><div class="line">o</div><div class="line">input</div><div class="line">.</div><div class="line">o</div><div class="line"> $(LDLIBS)</div><div class="line">graphics.</div><div class="line">o</div><div class="line">: graphics.</div><div class="line">c</div><div class="line"> graphics.h</div><div class="line">    $(CC) -</div><div class="line">c</div><div class="line"> $(CFLAGS) graphics.</div><div class="line">c</div><div class="line"></div><div class="line">physics.</div><div class="line">o</div><div class="line">: physics.</div><div class="line">c</div><div class="line"> physics.h</div><div class="line">    $(CC) -</div><div class="line">c</div><div class="line"> $(CFLAGS) physics.</div><div class="line">c</div><div class="line">input</div><div class="line">.</div><div class="line">o</div><div class="line">: </div><div class="line">input</div><div class="line">.</div><div class="line">c</div><div class="line">input</div><div class="line">.h graphics.h physics.h</div><div class="line">    $(CC) -</div><div class="line">c</div><div class="line"> $(CFLAGS) </div><div class="line">input</div><div class="line">.</div><div class="line">c</div><div class="line"></div><div class="line">clean:</div><div class="line">    rm -</div><div class="line">f</div><div class="line"> game graphics.</div><div class="line">o</div><div class="line"> physics.</div><div class="line">o</div><div class="line">input</div><div class="line">.</div><div class="line">o</div></pre></td></tr></table></figure>
<p>Macros are overridden by macro definitions given as command line arguments in the form<code>name=value</code>. This allows the user to select their own build configuration.This is one of make’s most powerful and under-appreciated features.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ make CC=clang CFLAGS=</div><div class="line">&apos;-O3 -march=native&apos;</div></pre></td></tr></table></figure>
<p>If the user doesn’t want to specify these macros on every invocation, they can (cautiously) use make’s<code>-e</code>flag to set overriding macros definitions from the environment.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ export CC=clang</div><div class="line">$ export CFLAGS=-O3</div><div class="line">$ make -e all</div></pre></td></tr></table></figure>
<p>Some make implementations have other special kinds of macro assignment operators beyond simple assignment (<code>=</code>). These are unnecessary, so don’t worry about them.</p>
<h3 id="Inference-rules-so-that-you-can-stop-repeating-yourself"><a href="#Inference-rules-so-that-you-can-stop-repeating-yourself" class="headerlink" title="Inference rules so that you can stop repeating yourself"></a>Inference rules so that you can stop repeating yourself</h3><p>The road itself tells us far more than signs do. ―Tom Vanderbilt, Traffic: Why We Drive the Way We Do</p>
<p>There’s repetition across the three different object files. Wouldn’t it be nice if there was a way to communicate this pattern? Fortunately there is, in the form of<em>inteference rules</em>. It says that a target with a certain extension, with a prerequisite with another certain extension, is built a certain way. This will make more sense with an example.</p>
<p>In an inference rule, the target indicates the extensions. The<code>$&lt;</code>macro expands to the prerequisite, which is essential to making inference rules work generically. Unfortunately this macro is not available in target rules, as much as that would be useful.</p>
<p>For example, here’s an inference rule that teaches make how to build an object file from a C source file. This particular rule is one that is pre-defined by make, so you’ll never need to write this one yourself. I’ll include it for completeness.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">.c.</div><div class="line">o:</div><div class="line"></div><div class="line">    $(CC) $(CFLAGS) -c $</div><div class="line">&lt;</div></pre></td></tr></table></figure>
<p>These extensions must be added to<code>.SUFFIXES</code>before they will work. With that, the commands for the rules about object files can be omitted.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">CC     = </div><div class="line">cc</div><div class="line"></div><div class="line">CFLAGS = -W -O</div><div class="line">LDLIBS = -</div><div class="line">lm</div><div class="line"></div><div class="line"></div><div class="line">.POSIX:</div><div class="line">.SUFFIXES:</div><div class="line"></div><div class="line">al</div><div class="line">l:</div><div class="line"> game</div><div class="line">game: graphics.</div><div class="line">o</div><div class="line"> physics.</div><div class="line">o</div><div class="line">input</div><div class="line">.</div><div class="line">o</div><div class="line"></div><div class="line">    $(CC) $(LDFLAGS) -</div><div class="line">o</div><div class="line"> game graphics.</div><div class="line">o</div><div class="line"> physics.</div><div class="line">o</div><div class="line">input</div><div class="line">.</div><div class="line">o</div><div class="line"> $(LDLIBS)</div><div class="line">graphics.</div><div class="line">o</div><div class="line">: graphics.</div><div class="line">c</div><div class="line"> graphics.h</div><div class="line">physics.</div><div class="line">o</div><div class="line">: physics.</div><div class="line">c</div><div class="line"> physics.h</div><div class="line"></div><div class="line">input</div><div class="line">.</div><div class="line">o</div><div class="line">: </div><div class="line">input</div><div class="line">.</div><div class="line">c</div><div class="line">input</div><div class="line">.h graphics.h physics.h</div><div class="line">clean:</div><div class="line">    rm -</div><div class="line">f</div><div class="line"> game graphics.</div><div class="line">o</div><div class="line"> physics.</div><div class="line">o</div><div class="line">input</div><div class="line">.</div><div class="line">o</div><div class="line"></div><div class="line"></div><div class="line">.SUFFIXES: .</div><div class="line">c</div><div class="line"> .</div><div class="line">o</div><div class="line"></div><div class="line">.</div><div class="line">c</div><div class="line">.</div><div class="line">o</div><div class="line">:</div><div class="line">    $(CC) $(CFLAGS) -</div><div class="line">c</div><div class="line"> $</div><div class="line">&lt;</div></pre></td></tr></table></figure>
<p>The first empty<code>.SUFFIXES</code>clears the suffix list. The second one adds<code>.c</code>and<code>.o</code>to the now-empty suffix list.</p>
<h3 id="Other-target-conventions"><a href="#Other-target-conventions" class="headerlink" title="Other target conventions"></a>Other target conventions</h3><p>Conventions are, indeed, all that shield us from the shivering void, though often they do so but poorly and desperately. ―Robert Aickman</p>
<p>Users usually expect an “install” target that installs the built program, libraries, man pages, etc. By convention this target should use the<code>PREFIX</code>and<code>DESTDIR</code>macros.</p>
<p>The<code>PREFIX</code>macro should default to<code>/usr/local</code>, and since it’s a macro the user can override it to install elsewhere,<a href="http://nullprogram.com/blog/2017/06/19/">such as in their home directory</a>. The user should override it for both building and installing, since the prefix may need to be built into the binary (e.g.<code>-DPREFIX=$(PREFIX)</code>).</p>
<p>The<code>DESTDIR</code>is macro is used for<em>staged builds</em>, so that it gets installed under a fake root directory for the sake of packaging. Unlike PREFIX, it will not actually be run from this directory.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">CC     = </div><div class="line">cc</div><div class="line"></div><div class="line">CFLAGS = -W -O</div><div class="line">LDLIBS = -</div><div class="line">lm</div><div class="line"></div><div class="line">PREFIX = /usr/local</div><div class="line"></div><div class="line">.POSIX:</div><div class="line"></div><div class="line">al</div><div class="line">l:</div><div class="line"> game</div><div class="line">instal</div><div class="line">l:</div><div class="line"> game</div><div class="line">    </div><div class="line">mkdir</div><div class="line"> -</div><div class="line">p</div><div class="line"> $(DESTDIR)$(PREFIX)/bin</div><div class="line">    </div><div class="line">mkdir</div><div class="line"> -</div><div class="line">p</div><div class="line"> $(DESTDIR)$(PREFIX)/share/man/man1</div><div class="line">    </div><div class="line">cp</div><div class="line"> -</div><div class="line">f</div><div class="line"> game $(DESTDIR)$(PREFIX)/bin</div><div class="line">    gzip </div><div class="line">&lt;</div><div class="line"> game.</div><div class="line">1</div><div class="line">&gt;</div><div class="line"> $(DESTDIR)$(PREFIX)/share/man/man1/game.</div><div class="line">1</div><div class="line">.gz</div><div class="line">game: graphics.</div><div class="line">o</div><div class="line"> physics.</div><div class="line">o</div><div class="line">input</div><div class="line">.</div><div class="line">o</div><div class="line"></div><div class="line">    $(CC) $(LDFLAGS) -</div><div class="line">o</div><div class="line"> game graphics.</div><div class="line">o</div><div class="line"> physics.</div><div class="line">o</div><div class="line">input</div><div class="line">.</div><div class="line">o</div><div class="line"> $(LDLIBS)</div><div class="line">graphics.</div><div class="line">o</div><div class="line">: graphics.</div><div class="line">c</div><div class="line"> graphics.h</div><div class="line">physics.</div><div class="line">o</div><div class="line">: physics.</div><div class="line">c</div><div class="line"> physics.h</div><div class="line"></div><div class="line">input</div><div class="line">.</div><div class="line">o</div><div class="line">: </div><div class="line">input</div><div class="line">.</div><div class="line">c</div><div class="line">input</div><div class="line">.h graphics.h physics.h</div><div class="line">clean:</div><div class="line">    rm -</div><div class="line">f</div><div class="line"> game graphics.</div><div class="line">o</div><div class="line"> physics.</div><div class="line">o</div><div class="line">input</div><div class="line">.</div><div class="line">o</div></pre></td></tr></table></figure>
<p>You may also want to provide an “uninstall” phony target that does the opposite.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">make</div><div class="line"> PREFIX=</div><div class="line">$HOME</div><div class="line">/.local install</div></pre></td></tr></table></figure>
<p>Other common targets are “mostlyclean” (like “clean” but don’t delete some slow-to-build targets), “distclean” (delete even more than “clean”), “test” (run the test suite), and “dist” (create a package).</p>
<h3 id="Complexity-and-growing-pains"><a href="#Complexity-and-growing-pains" class="headerlink" title="Complexity and growing pains"></a>Complexity and growing pains</h3><p>One of make’s big weak points is scaling up as a project grows in size.</p>
<h4 id="Recursive-Makefiles"><a href="#Recursive-Makefiles" class="headerlink" title="Recursive Makefiles"></a>Recursive Makefiles</h4><p>As your growing project is broken into subdirectories, you may be tempted to put a Makefile in each subdirectory and invoke them recursively.</p>
<p><a href="http://aegis.sourceforge.net/auug97.pdf"><strong>Don’t use recursive Makefiles</strong></a>. It breaks the dependency tree across separate instances of make and typically results in a fragile build. There’s nothing good about it. Have one Makefile at the root of your project and invoke make there. You may have to teach your text editor how to do this.</p>
<p>When talking about files in subdirectories, just include the subdirectory in the name. Everything will work the same as far as make is concerned, including inference rules.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">src/graphics.o</div><div class="line">: src/graphics.c</div><div class="line"></div><div class="line">src/physics.o</div><div class="line">: src/physics.c</div><div class="line"></div><div class="line">src/input.o</div><div class="line">: src/input.c</div></pre></td></tr></table></figure>
<h4 id="Out-of-source-builds"><a href="#Out-of-source-builds" class="headerlink" title="Out-of-source builds"></a>Out-of-source builds</h4><p>Keeping your object files separate from your source files is a nice idea. When it comes to make, there’s good news and bad news.</p>
<p>The good news is that make can do this. You can pick whatever file names you like for targets and prerequisites.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">obj/</div><div class="line">input</div><div class="line">.o</div><div class="line">: src/</div><div class="line">input</div><div class="line">.c</div></pre></td></tr></table></figure>
<p>The bad news is that inference rules are not compatible with out-of-source builds. You’ll need to repeat the same commands for each rule as if inference rules didn’t exist. This is tedious for large projects, so you may want to have some sort of “configure” script, even if hand-written, to generate all this for you. This is essentially what CMake is all about. That, plus dependency management.</p>
<h4 id="Dependency-management"><a href="#Dependency-management" class="headerlink" title="Dependency management"></a>Dependency management</h4><p>Another problem with scaling up is tracking the project’s ever-changing dependencies across all the source files. Missing a dependency means the build may not be correct unless you<code>make clean</code>first.</p>
<p>If you go the route of using a script to generate the tedious parts of the Makefile, both GCC and Clang have a nice feature for generating all the Makefile dependencies for you (<code>-MM</code>,<code>-MT</code>), at least for C and C++. There are lots of tutorials for doing this dependency generation on the fly as part of the build, but it’s fragile and slow. Much better to do it all up front and “bake” the dependencies into the Makefile so that make can do its job properly. If the dependencies change, rebuild your Makefile.</p>
<p>For example, here’s what it looks like invoking gcc’s dependency generator against the imaginary<code>input.c</code>for an out-of-source build:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ gcc $CFLAGS -MM -MT &apos;$(BUILD)/</div><div class="line">input</div><div class="line">.o</div><div class="line">&apos; </div><div class="line">input</div><div class="line">.c</div><div class="line"></div><div class="line">$(BUILD)/</div><div class="line">input</div><div class="line">.o</div><div class="line">: </div><div class="line">input</div><div class="line">.c</div><div class="line">input</div><div class="line">.h</div><div class="line"> graphics</div><div class="line">.h</div><div class="line"> physics</div><div class="line">.h</div></pre></td></tr></table></figure>
<p>Notice the output is in Makefile’s rule format.</p>
<p>Unfortunately this feature strips the leading paths from the target, so, in practice, using it is always more complicated than it should be (e.g. it requires the use of<code>-MT</code>).</p>
<h4 id="Microsoft’s-Nmake"><a href="#Microsoft’s-Nmake" class="headerlink" title="Microsoft’s Nmake"></a>Microsoft’s Nmake</h4><p>Microsoft has an implementation of make called Nmake, which<a href="http://nullprogram.com/blog/2016/06/13/">comes with Visual Studio</a>. It’s_nearly_a POSIX-compatible make, but necessarily breaks from the standard in some places. Their cl.exe compiler uses<code>.obj</code>as the object file extension and<code>.exe</code>for binaries, both of which differ from the unix world, so it has different build-in inference rules. Windows also lacks a Bourne shell and the standard unix tools, so all of the commands will necessarily be different.</p>
<p>There’s no equivalent of<code>rm -f</code>on Windows, so good luck writing a proper “clean” target. No,<code>del /f</code>isn’t the same.</p>
<p>So while it’s close to POSIX make, it’s not practical to write a Makefile that will simultaneously work with both POSIX make and Nmake. These need to be separate Makefiles.</p>
<h3 id="May-your-Makefiles-be-portable"><a href="#May-your-Makefiles-be-portable" class="headerlink" title="May your Makefiles be portable"></a>May your Makefiles be portable</h3><p>It’s nice to have reliable, portable Makefiles that just work anywhere.<a href="http://nullprogram.com/blog/2017/03/30/">Code to the standards</a>and you don’t need feature tests or other sorts of special treatment.</p>
<p>Source: <a href="http://www.tuicool.com/articles/hit/Zn6z2uZ">http://nullprogram.com/blog/2017/08/20/</a></p>

  </div>
  

 <!-- jsSocials -->
<script src="/jssocials-1.4.0/jssocials.min.js"></script>
<link rel="stylesheet" href="/jssocials-1.4.0/jssocials.css">
<link rel="stylesheet" href="/jssocials-1.4.0/jssocials-theme-flat.css">

<div class="socials-share-btn"></div>
<script>
  if ($) {
    $(document).ready(function(){
      $(".socials-share-btn").jsSocials({
        shares: ["email", "twitter", "facebook", "googleplus", "linkedin", "pinterest", "stumbleupon", "whatsapp"]
      });
    })
  }
</script>


  
<section id="comments">
  <div id="disqus_thread"></div>
</section>
<script>
  var disqus_shortname = 'gmagon';
  var disqus_url = 'https://gmagon.com/blog/2017/08/21/may-your-makefiles-be-portable/index.html';
  var disqus_title = "May your Makefiles be portable";
  var disqus_config = function(){
    this.language = 'en';
  };
  (function(){
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'https://go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

  <script src="/js/audios.js"></script>
</article>

          </div>
      
          <aside id="article-toc" role="navigation">
                <div id="article-toc-inner">
                  <strong class="sidebar-title">Contents</strong>
                  <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#What’s-in-a-Makefile"><span class="toc-text">What’s in a Makefile?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Adding-commands-to-rules"><span class="toc-text">Adding commands to rules</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Invoking-make-and-choosing-targets"><span class="toc-text">Invoking make and choosing targets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Customize-the-build-with-macros"><span class="toc-text">Customize the build with macros</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Inference-rules-so-that-you-can-stop-repeating-yourself"><span class="toc-text">Inference rules so that you can stop repeating yourself</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Other-target-conventions"><span class="toc-text">Other target conventions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Complexity-and-growing-pains"><span class="toc-text">Complexity and growing pains</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Recursive-Makefiles"><span class="toc-text">Recursive Makefiles</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Out-of-source-builds"><span class="toc-text">Out-of-source builds</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dependency-management"><span class="toc-text">Dependency management</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Microsoft’s-Nmake"><span class="toc-text">Microsoft’s Nmake</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#May-your-Makefiles-be-portable"><span class="toc-text">May your Makefiles be portable</span></a></li></ol>
                  <a href="#" id="article-toc-top">Back to Top</a>
                </div>
          </aside>
        </div>
      </article>
    </div>
  </div>
</div>

<div class="class-content-wrap">
  <div class="inner">
    <div class="inner-wrap landing-bunting">
      <div class="intro-sub-content-wrap">
      </div>
    </div>
  </div>
</div>



    <footer id="footer" class="landing-bunting font-e3">
  <div class="inner">
    <div id="footer-some-docs">
        <a href="/terms_conditions.html" class="footer-doc-link" >Terms & Conditions</a>
        <a href="/privacy.html" class="footer-doc-link" >Privacy</a>
        <a href="/end-user-license-agreement.html" class="footer-doc-link" >License Agreement</a>
    </div>
    <div id="footer-copyright">
       <a href="" > Copyright &copy; 2017 Gmagon,Inc. All rights reserved. </a>
    </div>
    <div id="footer-links">
      
      <a href="https://twitter.com/gmagonshare" class="footer-link" target="_blank" rel="nofollow me noopener noreferrer" ><i class="fa fa-twitter"></i></a>
      
      <a href="https://www.facebook.com/gmagonshare" class="footer-link" target="_blank" rel="nofollow me noopener noreferrer" ><i class="fa fa-facebook"></i></a>
      <a href="https://www.youtube.com/gmagonshare" class="footer-link" target="_blank" rel="nofollow me noopener noreferrer" ><i class="fa fa-youtube"></i></a>
      <a href="https://www.instagram.com/gmagonshare" class="footer-link" target="_blank" rel="nofollow me noopener noreferrer" ><i class="fa fa-instagram"></i></a>
    </div>
  </div>

  <div id="footer-security">
       <p>
          <img src="/asset/images/security/klogo.png">
          <img src="/asset/images/security/mcafee.png">
          <img src="/asset/images/security/cmmodo_scanned.png">
          <img src="/asset/images/security/softonic_tested.png">
          <img src="/asset/images/security/tested_by_sucuri.png">
          <img src="/asset/images/security/norton.png">
          <img src="/asset/images/security/eset_logo.png">
       </p>
    </div>
</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/" class="mobile-nav-link ">Home</a><a href="/products/" class="mobile-nav-link ">Products</a><a href="/guide/" class="mobile-nav-link ">Guide</a><a href="/support/" class="mobile-nav-link ">Support</a><a href="/blog/" class="mobile-nav-link ">Blog</a>
      
    </ul>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>English</span></span>
    <select id="mobile-lang-select" data-canonical="">
      
        <option value="en" selected>English</option>
      
    </select>
  </div>
</nav>

  <!-- Scripts -->
<script src="/build/js/main-8277743eaa.js"></script>
<!-- <script src="https://cdn.jsdelivr.net/retinajs/1.3.0/retina.min.js" async></script> -->

<!-- totop -->
<div id="gmagon_totop" style="position:fixed;bottom:150px;right:30px;cursor: pointer;">
  <a title="Back to top"><img src="/asset/images/scroll-up.png"/></a>
</div>
<script src="/js/totop.js"></script>





<!-- Google Analytics -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-99314951-1', 'auto');
  ga('send', 'pageview');
</script>


</body>
</html>